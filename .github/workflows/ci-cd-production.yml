name: CI/CD - Production Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

env:
  NODE_VERSION: '18'

jobs:
  # Job 1: æ¸¬è©¦å’Œé©—è­‰
  test:
    name: æ¸¬è©¦å’Œé©—è­‰
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£å¾Œç«¯ä¾è³´
        run: npm ci

      - name: å¾Œç«¯ Linting
        run: npm run lint || echo "Linting å®Œæˆ"

      - name: å®‰è£å‰ç«¯ä¾è³´
        run: |
          cd client
          npm ci

      - name: å‰ç«¯ Linting
        run: |
          cd client
          npm run lint || echo "Linting å®Œæˆ"

      # - name: é‹è¡Œæ¸¬è©¦
      #   run: |
      #     npm test
      #     cd client && npm test

  # Job 2: å»ºæ§‹å‰ç«¯
  build-frontend:
    name: å»ºæ§‹å‰ç«¯ (Production)
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: å®‰è£ä¾è³´
        run: |
          cd client
          npm ci

      - name: å»ºæ§‹ç”Ÿç”¢ç‰ˆæœ¬
        env:
          REACT_APP_API_URL: ${{ secrets.PROD_API_URL }}
          REACT_APP_SERVER_URL: ${{ secrets.PROD_SERVER_URL }}
          REACT_APP_STRIPE_PUBLISHABLE_KEY: ${{ secrets.PROD_STRIPE_PUBLISHABLE_KEY }}
          REACT_APP_GA_TRACKING_ID: ${{ secrets.GA_TRACKING_ID }}
          REACT_APP_ENV: production
          NODE_ENV: production
          GENERATE_SOURCEMAP: false
          INLINE_RUNTIME_CHUNK: false
        run: |
          cd client
          npm run build

      - name: é¡¯ç¤ºå»ºæ§‹ä¿¡æ¯
        run: |
          echo "å»ºæ§‹å¤§å°:"
          du -sh client/build
          echo ""
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -lh client/build/

      - name: ä¸Šå‚³å»ºæ§‹ç”¢ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: client/build/
          retention-days: 7

  # Job 3: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿç”¢æœå‹™å™¨
    runs-on: ubuntu-latest
    needs: build-frontend
    environment:
      name: production
      url: https://picklevibes.hk
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3

      - name: ä¸‹è¼‰å»ºæ§‹ç”¢ç‰©
        uses: actions/download-artifact@v3
        with:
          name: frontend-build
          path: client/build/

      - name: é¡¯ç¤ºä¸‹è¼‰çš„æ–‡ä»¶
        run: |
          echo "ä¸‹è¼‰çš„å»ºæ§‹æ–‡ä»¶:"
          ls -lh client/build/

      - name: å‰µå»ºéƒ¨ç½²åŒ…
        run: |
          # å‰µå»ºæ™‚é–“æˆ³
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # å‰µå»ºéƒ¨ç½²ç›®éŒ„
          mkdir -p deploy
          
          # è¤‡è£½å‰ç«¯å»ºæ§‹
          cp -r client/build deploy/
          
          # è¤‡è£½å¾Œç«¯æ–‡ä»¶
          cp -r server deploy/
          cp package*.json deploy/
          cp ecosystem.config.js deploy/
          
          # å‰µå»ºå£“ç¸®åŒ…
          cd deploy
          tar -czf ../deploy-$TIMESTAMP.tar.gz .
          cd ..
          
          echo "éƒ¨ç½²åŒ…å·²å‰µå»º: deploy-$TIMESTAMP.tar.gz"
          ls -lh deploy-*.tar.gz

      - name: ä¸Šå‚³åˆ°ç”Ÿç”¢æœå‹™å™¨
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          source: "deploy-*.tar.gz"
          target: "/tmp/"

      - name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            set -e
            
            echo "ğŸš€ é–‹å§‹éƒ¨ç½²..."
            
            # è¨­ç½®è®Šæ•¸
            APP_DIR="/var/www/picklevibes"
            BACKUP_DIR="$APP_DIR/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # å‰µå»ºå‚™ä»½ç›®éŒ„
            mkdir -p $BACKUP_DIR
            
            # å‚™ä»½ç•¶å‰ç‰ˆæœ¬
            echo "ğŸ“¦ å‚™ä»½ç•¶å‰ç‰ˆæœ¬..."
            if [ -d "$APP_DIR/client/build" ]; then
              cp -r $APP_DIR/client/build $BACKUP_DIR/build-$TIMESTAMP
              echo "âœ“ å‰ç«¯å·²å‚™ä»½"
            fi
            
            if [ -d "$APP_DIR/server" ]; then
              cp -r $APP_DIR/server $BACKUP_DIR/server-$TIMESTAMP
              echo "âœ“ å¾Œç«¯å·²å‚™ä»½"
            fi
            
            # è§£å£“æ–°ç‰ˆæœ¬
            echo "ğŸ“¥ è§£å£“æ–°ç‰ˆæœ¬..."
            cd /tmp
            DEPLOY_FILE=$(ls -t deploy-*.tar.gz | head -1)
            tar -xzf $DEPLOY_FILE -C $APP_DIR/
            
            # å®‰è£å¾Œç«¯ä¾è³´
            echo "ğŸ“¦ å®‰è£å¾Œç«¯ä¾è³´..."
            cd $APP_DIR
            npm install --production
            
            # æ›´æ–°ç’°å¢ƒé…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
            if [ -f "$APP_DIR/.env.production" ]; then
              cp $APP_DIR/.env.production $APP_DIR/.env
            fi
            
            # é‡å•Ÿæ‡‰ç”¨
            echo "ğŸ”„ é‡å•Ÿæ‡‰ç”¨..."
            pm2 restart picklevibes || pm2 start ecosystem.config.js
            
            # æª¢æŸ¥ç‹€æ…‹
            sleep 3
            pm2 status picklevibes
            
            # æ¸…ç†
            echo "ğŸ§¹ æ¸…ç†..."
            rm -f /tmp/deploy-*.tar.gz
            
            # æ¸…ç†èˆŠå‚™ä»½ï¼ˆä¿ç•™æœ€è¿‘5å€‹ï¼‰
            cd $BACKUP_DIR
            ls -t | tail -n +6 | xargs -r rm -rf
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ç•¶å‰ç‰ˆæœ¬: $(date)"

      - name: å¥åº·æª¢æŸ¥
        run: |
          echo "ğŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥..."
          sleep 10
          
          # æª¢æŸ¥ API å¥åº·ç‹€æ…‹
          HEALTH_URL="${{ secrets.PROD_API_URL }}/health"
          
          for i in {1..5}; do
            if curl -f -s "$HEALTH_URL" > /dev/null; then
              echo "âœ… å¥åº·æª¢æŸ¥é€šé"
              exit 0
            fi
            echo "ç­‰å¾…æœå‹™å•Ÿå‹•... ($i/5)"
            sleep 5
          done
          
          echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—"
          exit 1

  # Job 4: é€šçŸ¥
  notify:
    name: ç™¼é€éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()
    
    steps:
      - name: ç™¼é€ Slack é€šçŸ¥
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½² ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}
            åˆ†æ”¯: ${{ github.ref }}
            æäº¤: ${{ github.sha }}
            ä½œè€…: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # - name: ç™¼é€ Email é€šçŸ¥
      #   if: failure()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 465
      #     username: ${{ secrets.MAIL_USERNAME }}
      #     password: ${{ secrets.MAIL_PASSWORD }}
      #     subject: ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å¤±æ•—
      #     body: éƒ¨ç½²å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ GitHub Actions æ—¥èªŒ
      #     to: devops@picklevibes.hk

