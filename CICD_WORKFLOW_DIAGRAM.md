# CI/CD 工作流程圖

## 🎯 完整流程概覽

```
┌────────────────────────────────────────────────────────────────┐
│                     開發者工作流程                              │
└────────────────────────────────────────────────────────────────┘
                              ↓
    ┌─────────────────────────────────────────────────┐
    │  本地開發                                        │
    │  - 編寫代碼                                      │
    │  - 本地測試                                      │
    │  - git commit                                   │
    └─────────────────────────────────────────────────┘
                              ↓
    ┌─────────────────────────────────────────────────┐
    │  git push origin <branch>                       │
    └─────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   GitHub Actions 自動觸發                        │
└─────────────────────────────────────────────────────────────────┘

```

## 📋 UAT 環境流程

```
推送到 'uat' 分支
         ↓
┌─────────────────────────────────────┐
│  階段 1: 測試和驗證                  │
│  ⏱️  時間: 3-5分鐘                   │
│                                     │
│  ✓ 安裝後端依賴                      │
│  ✓ 安裝前端依賴                      │
│  ✓ Linting 檢查                     │
│  ✓ 單元測試（可選）                  │
└─────────────────────────────────────┘
         ↓ [測試通過]
┌─────────────────────────────────────┐
│  階段 2: 建構 UAT 版本               │
│  ⏱️  時間: 5-10分鐘                  │
│                                     │
│  建構環境:                           │
│  - REACT_APP_API_URL:               │
│    https://api-uat.picklevibes.hk   │
│  - REACT_APP_STRIPE_KEY: pk_test_   │
│  - REACT_APP_ENV: uat               │
│                                     │
│  ✓ 使用 UAT 配置建構                 │
│  ✓ 優化和壓縮                        │
│  ✓ 上傳建構產物 (artifact)           │
└─────────────────────────────────────┘
         ↓ [建構成功]
┌─────────────────────────────────────┐
│  階段 3: 部署到 UAT 服務器            │
│  ⏱️  時間: 2-5分鐘                   │
│                                     │
│  ✓ 下載建構產物                      │
│  ✓ 創建部署包                        │
│  ✓ 上傳到 UAT 服務器                 │
│  ✓ 備份舊版本                        │
│  ✓ 解壓新版本                        │
│  ✓ 安裝後端依賴                      │
│  ✓ 重啟 PM2 (picklevibes-uat)      │
└─────────────────────────────────────┘
         ↓ [部署完成]
┌─────────────────────────────────────┐
│  階段 4: 驗證和通知                  │
│  ⏱️  時間: 1分鐘                     │
│                                     │
│  ✓ 健康檢查 API                      │
│  ✓ 發送 Slack 通知                  │
│  ✓ 更新部署狀態                      │
└─────────────────────────────────────┘
         ↓
    ✅ UAT 部署完成
    https://uat.picklevibes.hk
```

## 🚀 生產環境流程

```
推送到 'main' 分支
         ↓
┌─────────────────────────────────────┐
│  階段 1: 測試和驗證                  │
│  ⏱️  時間: 3-5分鐘                   │
│                                     │
│  ✓ 安裝後端依賴                      │
│  ✓ 安裝前端依賴                      │
│  ✓ Linting 檢查                     │
│  ✓ 單元測試                          │
│  ✓ 安全掃描（可選）                  │
└─────────────────────────────────────┘
         ↓ [測試通過]
┌─────────────────────────────────────┐
│  階段 2: 建構生產版本                │
│  ⏱️  時間: 5-10分鐘                  │
│                                     │
│  建構環境:                           │
│  - REACT_APP_API_URL:               │
│    https://api.picklevibes.hk       │
│  - REACT_APP_STRIPE_KEY: pk_live_   │
│  - REACT_APP_ENV: production        │
│  - GENERATE_SOURCEMAP: false        │
│                                     │
│  ✓ 使用生產配置建構                  │
│  ✓ 優化和壓縮                        │
│  ✓ 移除 console.log                 │
│  ✓ 代碼分割                          │
│  ✓ 上傳建構產物                      │
└─────────────────────────────────────┘
         ↓ [建構成功]
┌─────────────────────────────────────┐
│  🔒 需要人工審核（如已設置）          │
│                                     │
│  等待審核者批准...                   │
│  - 查看建構產物                      │
│  - 確認變更內容                      │
│  - 批准或拒絕                        │
└─────────────────────────────────────┘
         ↓ [審核通過]
┌─────────────────────────────────────┐
│  階段 3: 部署到生產服務器             │
│  ⏱️  時間: 2-5分鐘                   │
│                                     │
│  ✓ 下載建構產物                      │
│  ✓ 創建部署包                        │
│  ✓ 上傳到生產服務器                  │
│  ✓ 備份舊版本 (自動備份)             │
│  ✓ 解壓新版本                        │
│  ✓ 安裝後端依賴                      │
│  ✓ 更新環境變數                      │
│  ✓ 重啟 PM2 (picklevibes)           │
└─────────────────────────────────────┘
         ↓ [部署完成]
┌─────────────────────────────────────┐
│  階段 4: 驗證和通知                  │
│  ⏱️  時間: 1-2分鐘                   │
│                                     │
│  ✓ 健康檢查 API (重試5次)            │
│  ✓ 煙霧測試（可選）                  │
│  ✓ 發送 Slack/Email 通知            │
│  ✓ 更新部署記錄                      │
└─────────────────────────────────────┘
         ↓
    ✅ 生產部署完成
    https://picklevibes.hk
```

## 🔄 分支策略和部署流程

```
┌─────────────────────────────────────────────────────────┐
│                     Git 分支結構                         │
└─────────────────────────────────────────────────────────┘

feature/new-feature
         │
         │ (開發完成)
         ↓
      develop
         │
         │ (功能測試通過)
         ↓
       uat  ────────────→  自動部署到 UAT
         │                 https://uat.picklevibes.hk
         │
         │ (UAT 測試通過)
         ↓
      main  ────────────→  自動部署到生產
                           https://picklevibes.hk
                           (可能需要審核)
```

## 📊 時間線對比

### UAT 部署時間線

```
00:00  推送代碼
00:01  GitHub Actions 啟動
00:02  開始測試
00:06  測試完成，開始建構
00:15  建構完成，開始部署
00:18  部署到服務器
00:20  健康檢查和通知
00:21  ✅ 完成

總時長: ~21 分鐘
```

### 生產部署時間線（含審核）

```
00:00  推送代碼
00:01  GitHub Actions 啟動
00:02  開始測試
00:06  測試完成，開始建構
00:15  建構完成，等待審核
--:--  ⏸️ 人工審核（時間不定）
00:20  審核通過，開始部署
00:23  部署到服務器
00:25  健康檢查和通知
00:26  ✅ 完成

總時長: ~26 分鐘（不含審核等待）
```

## 🛠️ 服務器架構

```
┌─────────────────────────────────────────────────────────┐
│                     GitHub Actions                       │
│                     (建構服務器)                          │
│                                                          │
│  ✓ 測試代碼                                              │
│  ✓ 建構前端                                              │
│  ✓ 打包部署文件                                          │
└─────────────────────────────────────────────────────────┘
                        │
                        │ SCP/SSH
                        ↓
┌─────────────────────────────────────────────────────────┐
│                   應用服務器（生產）                       │
│                   /var/www/picklevibes                   │
│                                                          │
│  ┌──────────────────────────────────────────┐          │
│  │  Nginx (反向代理)                         │          │
│  │  - 靜態文件服務                            │          │
│  │  - API 代理到後端                         │          │
│  └──────────────────────────────────────────┘          │
│                        │                                 │
│  ┌──────────────────────────────────────────┐          │
│  │  前端 (React Build)                       │          │
│  │  /var/www/picklevibes/client/build       │          │
│  └──────────────────────────────────────────┘          │
│                        │                                 │
│  ┌──────────────────────────────────────────┐          │
│  │  後端 (Node.js + PM2)                     │          │
│  │  /var/www/picklevibes/server             │          │
│  │  - Express API                            │          │
│  │  - 業務邏輯                                │          │
│  └──────────────────────────────────────────┘          │
│                        │                                 │
│  ┌──────────────────────────────────────────┐          │
│  │  備份目錄                                  │          │
│  │  /var/www/picklevibes/backups            │          │
│  │  - 自動備份舊版本                          │          │
│  │  - 保留最近5個版本                         │          │
│  └──────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────┘
                        │
                        │
                        ↓
┌─────────────────────────────────────────────────────────┐
│                   MongoDB Atlas                          │
│                   (數據庫服務器)                          │
│                                                          │
│  picklevibes (生產數據庫)                                │
└─────────────────────────────────────────────────────────┘
```

## 🚨 錯誤處理流程

```
部署過程中出現錯誤
         ↓
    [階段識別]
         │
    ┌────┴────┬────────────┬─────────────┐
    │         │            │             │
    ↓         ↓            ↓             ↓
  測試失敗   建構失敗    部署失敗    健康檢查失敗
    │         │            │             │
    ↓         ↓            ↓             ↓
  停止流程   停止流程    自動回滾      告警通知
    │         │            │             │
    ↓         ↓            ↓             ↓
發送通知   發送通知    發送通知      手動介入
    │         │            │             │
    ↓         ↓            ↓             ↓
  修復代碼   檢查配置    檢查服務器   檢查應用
    │         │            │             │
    └────┬────┴────────────┴─────────────┘
         ↓
    重新推送代碼
         ↓
    觸發新的部署
```

## 📈 監控和告警

```
┌─────────────────────────────────────────┐
│          GitHub Actions 監控             │
│  - 執行狀態                              │
│  - 執行時間                              │
│  - 成功/失敗率                           │
└─────────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│          應用監控 (PM2)                  │
│  - CPU 使用率                            │
│  - 內存使用率                            │
│  - 錯誤日誌                              │
│  - 重啟次數                              │
└─────────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│          通知系統                        │
│  - Slack 即時通知                        │
│  - Email 告警                            │
│  - 部署報告                              │
└─────────────────────────────────────────┘
```

## 🎯 關鍵指標 (KPIs)

```
部署頻率 (Deployment Frequency)
├─ UAT: 每天 1-3 次
└─ 生產: 每週 1-2 次

前置時間 (Lead Time)
├─ 從提交到 UAT: ~21 分鐘
└─ 從提交到生產: ~26 分鐘 (不含審核)

變更失敗率 (Change Failure Rate)
└─ 目標: < 15%

平均恢復時間 (MTTR)
└─ 目標: < 1 小時

部署成功率
├─ UAT: 目標 > 95%
└─ 生產: 目標 > 98%
```

## 💡 最佳實踐流程

```
1. 功能開發
   ↓
2. 本地測試
   ↓
3. 提交到 feature 分支
   ↓
4. 創建 PR 到 develop
   ↓
5. 代碼審查
   ↓
6. 合併到 develop
   ↓
7. 合併到 uat → 自動部署
   ↓
8. UAT 測試（手動）
   ↓
9. 測試通過後合併到 main
   ↓
10. 自動部署到生產（可能需要審核）
   ↓
11. 監控和驗證
   ↓
12. 完成！✅
```

---

**提示**: 這些流程圖提供了視覺化的 CI/CD 流程概覽。詳細配置請參考 `CICD_SETUP_GUIDE.md`。

